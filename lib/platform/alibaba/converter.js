const fs=require("fs"),sysPath=require("path"),gulp=require("gulp"),rename=require("gulp-rename"),replace=require("gulp-replace"),md5Hex=require("md5-hex"),ab2str=require("arraybuffer-to-string"),str2ab=require("to-buffer"),through2=require("through2"),{DOMParser:DOMParser}=require("xmldom"),config=require("../../config"),logger=require("../../utils/logger"),converter=require("../../converter/src/alibaba"),scopeStyle=require("../../scope/scope-style"),scopeTemplate=require("../../scope/scope-template"),diffTag=require("../diff/index").diffTag("alipay"),diffDefine=require("../diff/index").diffDefine("alipay"),path=require("path");function convert(e={}){const s=e.source||"./src",r=e.target||"./alibaba",t=e.config&&e.config.plugins||{},p={};function i(e,s,r,t,i){t=t||config.getAssets(e),gulp.src(t).pipe(gulp.dest(s)),gulp.src(`${e}/**/*.wxss`).pipe(replace(/[\s\S]*/g,diffTag)).pipe(replace(/[\s\S]*/g,e=>converter.wxss(e))).pipe(through2.obj(function(e,s,r){const t=e.history[0].replace(e.base,"").replace(".wxss",""),p=e.history[0].replace(".wxss",".json"),i=e.history[0].replace(".wxss",".wxml");fs.exists(i,s=>{if(s){const s=fs.readFileSync(p),n=fs.readFileSync(i),o=ab2str(e.contents),l=/<import/.test(n),c=/"component":\s*true/.test(s);if(!l&&c){const s=`_${md5Hex(t)}`;scopeStyle(s,o).then(s=>{e.contents=str2ab(s),this.push(e),r()})}else this.push(e),r()}else this.push(e),r()})})).pipe(rename(e=>{e.extname=".acss"})).pipe(gulp.dest(s)),gulp.src(`${e}/**/*.wxml`).pipe(replace(/[\s\S]*/g,diffTag)).pipe(replace(/[\s\S]*/g,e=>converter.wxml(e))).pipe(through2.obj(function(e,s,r){const t=e.history[0].replace(e.base,"").replace(".wxml",""),p=e.history[0].replace(".wxml",".json");fs.exists(p,s=>{if(s){const s=fs.readFileSync(p);if(/"component":\s*true/.test(s)){const s=`_${md5Hex(t)}`,p=ab2str(e.contents),i=(new DOMParser).parseFromString(p);scopeTemplate(i,s);const n=i.toString().replace(/xmlns:a=""/g,"").replace(/&amp;/g,"&").replace(/&quot;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">");e.contents=str2ab(n),this.push(e),r()}else this.push(e),r()}else this.push(e),r()})})).pipe(rename(e=>{e.extname=".axml"})).pipe(gulp.dest(s));const n=[`${e}/**/*.json`,`!${e}/**/package.json`];i?gulp.src(n).pipe(replace(/[\s\S]*/g,e=>converter.json(e))).pipe(gulp.dest(s)).on("end",()=>{logger.info("处理 json 完成！")}):gulp.src(n).pipe(replace(/[\s\S]*/g,e=>converter.json(e))).pipe(through2.obj(function(e,s,t){const i=e.history[0].replace(e.base,""),n=i.split(sysPath.sep);let o=new Array(n.length-1).fill("..").join("/").replace(/^\.\./,"."),l=ab2str(e.contents);if(l=l.replace(/\/?plugin:\/\/([\s\S]*?)\/([\s\S]*?)"/g,(e,s,t)=>{if(r[s]){let e=p[s].publicComponents[t];return"/"===e[0]&&(e=e.slice(1)),"/"===o[0]&&(o=o.slice(1)),`${o}/plugins/${s}/${e}"`}return e}),"/app.json"===i){const e=JSON.parse(l);delete e.plugins,l=JSON.stringify(e,"",4)}e.contents=str2ab(l),this.push(e),t()})).pipe(gulp.dest(s)).on("end",()=>{logger.info("处理 json 完成！")}),gulp.src(`${e}/**/*.js`).pipe(replace(/[\s\S]*/g,diffTag)).pipe(replace(/[\s\S]*/g,e=>converter.script(e))).pipe(through2.obj(function(e,s,t){const p=e.history[0].replace(e.base,"").split(sysPath.sep);let n=p;i&&(n=p.concat([1,1]));const o=new Array(n.length-1).fill("..").concat("adaptor.js").join("/"),l=new Array(p.length-1).fill("..").join("/").replace(/^\.\./,".");let c=ab2str(e.contents);r&&(c=c.replace(/requirePlugin\(['"]([\s\S]*?)['"]\)/g,(e,s)=>e.replace("requirePlugin","require").replace(s,`${l}/plugins/${s}`)));const a=[`import wx from '${o.replace(/^\.\./,".")}';`,c].join("\r\n");e.contents=str2ab(a),this.push(e),t()})).pipe(replace(/[\s\S]*/g,diffDefine)).pipe(gulp.dest(s)).on("end",()=>{logger.info("处理 js 完成！")})}Object.keys(t).forEach(e=>{const s=t[e],r=path.join(process.cwd(),s,"plugin.json");console.log(r),p[e]=require(r)}),gulp.src(sysPath.resolve(__dirname,"../../adaptor/src/alibaba.js")).pipe(rename("adaptor.js")).pipe(gulp.dest(r)).on("end",()=>{logger.info("复制 adaptor.js 完成！")}),i(s,r,t,null,!1),t&&Object.keys(t).forEach(e=>{i(t[e],r+"/plugins/"+e,null,null,!0)})}module.exports=convert;