const fs=require("fs"),sysPath=require("path"),gulp=require("gulp"),rename=require("gulp-rename"),replace=require("gulp-replace"),md5Hex=require("md5-hex"),ab2str=require("arraybuffer-to-string"),str2ab=require("to-buffer"),through2=require("through2"),{DOMParser:DOMParser}=require("xmldom"),config=require("../../config"),logger=require("../../utils/logger"),converter=require("mp-converter").alibaba,scopeStyle=require("../../scope/scope-style"),scopeTemplate=require("../../scope/scope-template"),diffTag=require("../diff/index").diffTag("alipay");function convert(e={}){const s=e.source||"./src",r=e.target||"./alibaba",t=e.assets||config.getAssets(s);gulp.src(t).pipe(gulp.dest(r)),gulp.src(`${s}/**/*.wxss`).pipe(replace(/[\s\S]*/g,diffTag)).pipe(replace(/[\s\S]*/g,e=>converter.wxss(e))).pipe(through2.obj(function(e,s,r){const t=e.history[0].replace(e.base,"").replace(".wxss",""),p=e.history[0].replace(".wxss",".json"),o=e.history[0].replace(".wxss",".wxml");fs.exists(o,s=>{if(s){const s=fs.readFileSync(p),i=fs.readFileSync(o),a=ab2str(e.contents),c=/<import/.test(i),n=/"component":\s*true/.test(s);if(!c&&n){const s=`_${md5Hex(t)}`;scopeStyle(s,a).then(s=>{e.contents=str2ab(s),this.push(e),r()})}else this.push(e),r()}else this.push(e),r()})})).pipe(rename(e=>{e.extname=".acss"})).pipe(gulp.dest(r)),gulp.src(`${s}/**/*.wxml`).pipe(replace(/[\s\S]*/g,diffTag)).pipe(replace(/[\s\S]*/g,e=>converter.wxml(e))).pipe(through2.obj(function(e,s,r){const t=e.history[0].replace(e.base,"").replace(".wxml",""),p=e.history[0].replace(".wxml",".json");fs.exists(p,s=>{if(s){const s=fs.readFileSync(p);if(/"component":\s*true/.test(s)){const s=`_${md5Hex(t)}`,p=ab2str(e.contents),o=(new DOMParser).parseFromString(p);scopeTemplate(o,s);const i=o.toString().replace(/xmlns:a=""/g,"").replace(/&amp;/g,"&").replace(/&quot;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">");e.contents=str2ab(i),this.push(e),r()}else this.push(e),r()}else this.push(e),r()})})).pipe(rename(e=>{e.extname=".axml"})).pipe(gulp.dest(r));const p=`${r}/project.config.json`,o=[`${s}/**/*.json`];fs.exists(p,e=>{e&&o.push(`!${s}/project.config.json`),gulp.src(o).pipe(replace(/[\s\S]*/g,e=>converter.json(e))).pipe(gulp.dest(r))}),gulp.src(sysPath.resolve(__dirname,"../../../node_modules/mp-adaptor/lib/alibaba.js")).pipe(rename("adaptor.js")).pipe(gulp.dest(r)).on("end",()=>{logger.info("复制 adaptor.js 完成！")}),gulp.src(`${s}/**/*.js`).pipe(replace(/[\s\S]*/g,diffTag)).pipe(replace(/[\s\S]*/g,e=>converter.script(e))).pipe(through2.obj(function(e,s,r){const t=e.history[0].replace(e.base,"").split(sysPath.sep),p=[`import wx from '${new Array(t.length-1).fill("..").concat("adaptor.js").join("/").replace(/^\.\./,".")}';`,ab2str(e.contents)].join("\r\n");e.contents=str2ab(p),this.push(e),r()})).pipe(gulp.dest(r))}module.exports=convert;