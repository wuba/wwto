const fs=require("fs"),sysPath=require("path"),gulp=require("gulp"),ab2str=require("arraybuffer-to-string"),str2ab=require("to-buffer"),through2=require("through2"),rename=require("gulp-rename"),replace=require("gulp-replace"),config=require("../../config"),logger=require("../../utils/logger"),converter=require("mp-converter").baidu,diffTag=require("../diff/index").diffTag("baidu"),plugin=require("mp-plugin");function convert(e={}){const r=e.source||"./src",p=e.target||"./baidu",s=e.assets||config.getAssets(r);gulp.src(s).pipe(gulp.dest(p)),gulp.src(`${r}/**/*.wxss`).pipe(replace(/[\s\S]*/g,diffTag)).pipe(replace(/[\s\S]*/g,e=>converter.wxss(e))).pipe(rename(e=>{e.extname=".css"})).pipe(gulp.dest(p)),gulp.src(`${r}/**/*.wxml`).pipe(replace(/[\s\S]*/g,diffTag)).pipe(replace(/[\s\S]*/g,e=>converter.wxml(e))).pipe(rename(e=>{e.extname=".swan"})).pipe(gulp.dest(p));const i=`${p}/project.config.json`,t=[`${r}/**/*.json`];return fs.stat(i,e=>{e&&t.push(`!${r}/project.config.json`),gulp.src(t).pipe(replace(/[\s\S]*/g,e=>converter.json(e))).pipe(gulp.dest(p)).on("end",()=>{plugin.convertPlugin({source:p})})}),gulp.src(sysPath.resolve(__dirname,"../../adaptor/lib/baidu.js")).pipe(rename("adaptor.js")).pipe(gulp.dest(p)).on("end",()=>{logger.info("复制 adaptor.js 完成！")}),gulp.src(`${r}/**/*.js`).pipe(replace(/[\s\S]*/g,diffTag)).pipe(replace(/[\s\S]*/g,e=>converter.script(e))).pipe(through2.obj(function(e,r,p){const s=e.history[0].replace(e.base,"").split(sysPath.sep),i=[`import wx from '${new Array(s.length-1).fill("..").concat("adaptor.js").join("/").replace(/^\.\./,".")}';`,ab2str(e.contents)].join("\r\n");e.contents=str2ab(i),this.push(e),p()})).pipe(gulp.dest(p)).on("end",()=>{plugin.convertCaller({source:p})})}module.exports=convert;