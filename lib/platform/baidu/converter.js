const path=require("path"),sysPath=require("path"),gulp=require("gulp"),ab2str=require("arraybuffer-to-string"),str2ab=require("to-buffer"),through2=require("through2"),rename=require("gulp-rename"),replace=require("gulp-replace"),config=require("../../config"),logger=require("../../utils/logger"),converter=require("../../converter/src/baidu"),diffTag=require("../diff/index").diffTag("baidu"),diffDefine=require("../diff/index").diffDefine("baidu");function convert(e={}){const r=e.source||"./src",s=e.target||"./baidu";gulp.src(sysPath.resolve(__dirname,"../../adaptor/src/baidu.js")).pipe(rename("adaptor.js")).pipe(gulp.dest(s)).on("end",()=>{logger.info("复制 adaptor.js 完成！")});const n=e.config&&e.config.plugins||{},p={};function i(e,r,s,n,i){n=n||config.getAssets(e),gulp.src(n).pipe(gulp.dest(r)),gulp.src(`${e}/**/*.wxss`).pipe(replace(/[\s\S]*/g,diffTag)).pipe(replace(/[\s\S]*/g,e=>converter.wxss(e))).pipe(rename(e=>{e.extname=".css"})).pipe(gulp.dest(r)).on("end",()=>{logger.info("处理 wxss 完成！")}),gulp.src(`${e}/**/*.wxml`).pipe(replace(/[\s\S]*/g,diffTag)).pipe(replace(/[\s\S]*/g,e=>converter.wxml(e))).pipe(rename(e=>{e.extname=".swan"})).pipe(gulp.dest(r)).on("end",()=>{logger.info("处理 wxml 完成！")});const o=[`${e}/**/*.json`,`!${e}/**/package.json`];i?gulp.src(o).pipe(replace(/[\s\S]*/g,e=>converter.json(e))).pipe(gulp.dest(r)).on("end",()=>{logger.info("处理 json 完成！")}):gulp.src(o).pipe(replace(/[\s\S]*/g,e=>converter.json(e))).pipe(through2.obj(function(e,r,n){const i=e.history[0].replace(e.base,""),o=i.split(sysPath.sep);let t=new Array(o.length-1).fill("..").join("/").replace(/^\.\./,"."),l=ab2str(e.contents);if(l=l.replace(/\/?plugin:\/\/([\s\S]*?)\/([\s\S]*?)"/g,(e,r,n)=>{if(s[r]){let e=p[r].publicComponents[n];return"/"===e[0]&&(e=e.slice(1)),"/"===t[0]&&(t=t.slice(1)),`${t}/plugins/${r}/${e}"`}return e}),"/app.json"===i){const e=JSON.parse(l);delete e.plugins,l=JSON.stringify(e,"",4)}e.contents=str2ab(l),this.push(e),n()})).pipe(gulp.dest(r)).on("end",()=>{logger.info("处理 json 完成！")}),gulp.src(`${e}/**/*.js`).pipe(replace(/[\s\S]*/g,diffTag)).pipe(replace(/[\s\S]*/g,e=>converter.script(e))).pipe(through2.obj(function(e,r,n){const p=e.history[0].replace(e.base,"").split(sysPath.sep);let o=p;i&&(o=p.concat([1,1]));const t=new Array(o.length-1).fill("..").concat("adaptor.js").join("/"),l=new Array(p.length-1).fill("..").join("/").replace(/^\.\./,".");let c=ab2str(e.contents);s&&(c=c.replace(/requirePlugin\(['"]([\s\S]*?)['"]\)/g,(e,r)=>e.replace("requirePlugin","require").replace(r,`${l}/plugins/${r}`)));const a=[`import wx from '${t.replace(/^\.\./,".")}';`,c].join("\r\n");e.contents=str2ab(a),this.push(e),n()})).pipe(replace(/[\s\S]*/g,diffDefine)).pipe(gulp.dest(r)).on("end",()=>{logger.info("处理 js 完成！")})}Object.keys(n).forEach(e=>{const r=n[e],s=path.join(process.cwd(),r,"plugin.json");console.log(s),p[e]=require(s)}),i(r,s,n,null,!1),n&&Object.keys(n).forEach(e=>{i(n[e],s+"/plugins/"+e,null,null,!0)})}module.exports=convert;